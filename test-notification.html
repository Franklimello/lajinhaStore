<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Notifica√ß√£o - Novo Pedido</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        button:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>üß™ Teste de Notifica√ß√£o - Novo Pedido</h1>
    <p>Este formul√°rio simula a cria√ß√£o de um pedido para testar a notifica√ß√£o por e-mail autom√°tica.</p>
    
    <form id="testForm">
        <div class="grid">
            <div>
                <h3>üìã Informa√ß√µes do Pedido</h3>
                <div class="form-group">
                    <label for="total">Valor Total (R$):</label>
                    <input type="number" id="total" name="total" value="150.00" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status">
                        <option value="Aguardando Pagamento">Aguardando Pagamento</option>
                        <option value="Pago">Pago</option>
                        <option value="Preparando">Preparando</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">M√©todo de Pagamento:</label>
                    <select id="paymentMethod" name="paymentMethod">
                        <option value="pix">PIX</option>
                        <option value="dinheiro">Dinheiro</option>
                    </select>
                </div>
                
                <div class="form-group" id="dinheiroFields" style="display: none;">
                    <label for="valorPago">Valor Pago (R$):</label>
                    <input type="number" id="valorPago" name="valorPago" step="0.01">
                </div>
            </div>
            
            <div>
                <h3>üë§ Dados do Cliente</h3>
                <div class="form-group">
                    <label for="nome">Nome:</label>
                    <input type="text" id="nome" name="nome" value="Jo√£o Silva" required>
                </div>
                
                <div class="form-group">
                    <label for="telefone">Telefone:</label>
                    <input type="text" id="telefone" name="telefone" value="(11) 99999-9999" required>
                </div>
                
                <div class="form-group">
                    <label for="rua">Rua:</label>
                    <input type="text" id="rua" name="rua" value="Rua das Flores" required>
                </div>
                
                <div class="form-group">
                    <label for="numero">N√∫mero:</label>
                    <input type="text" id="numero" name="numero" value="123" required>
                </div>
                
                <div class="form-group">
                    <label for="bairro">Bairro:</label>
                    <input type="text" id="bairro" name="bairro" value="Centro" required>
                </div>
                
                <div class="form-group">
                    <label for="cidade">Cidade:</label>
                    <input type="text" id="cidade" name="cidade" value="S√£o Paulo" required>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <h3>üõí Itens do Pedido</h3>
            <div id="items">
                <div class="item-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" placeholder="Nome do produto" value="Produto Teste 1" style="flex: 2;">
                    <input type="number" placeholder="Qtd" value="2" style="flex: 1;">
                    <input type="number" placeholder="Pre√ßo" value="25.00" step="0.01" style="flex: 1;">
                </div>
                <div class="item-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" placeholder="Nome do produto" value="Produto Teste 2" style="flex: 2;">
                    <input type="number" placeholder="Qtd" value="1" style="flex: 1;">
                    <input type="number" placeholder="Pre√ßo" value="50.00" step="0.01" style="flex: 1;">
                </div>
            </div>
            <button type="button" onclick="addItem()">+ Adicionar Item</button>
        </div>
        
        <button type="submit" id="btnTestar">üß™ Testar Notifica√ß√£o</button>
        <button type="button" onclick="testarFuncao()">üîß Testar Fun√ß√£o Diretamente</button>
    </form>
    
    <div id="resultado"></div>

    <script>
        // Mostrar/ocultar campos de dinheiro
        document.getElementById('paymentMethod').addEventListener('change', function() {
            const dinheiroFields = document.getElementById('dinheiroFields');
            if (this.value === 'dinheiro') {
                dinheiroFields.style.display = 'block';
            } else {
                dinheiroFields.style.display = 'none';
            }
        });

        // Adicionar item
        function addItem() {
            const itemsDiv = document.getElementById('items');
            const newItem = document.createElement('div');
            newItem.className = 'item-row';
            newItem.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            newItem.innerHTML = `
                <input type="text" placeholder="Nome do produto" style="flex: 2;">
                <input type="number" placeholder="Qtd" value="1" style="flex: 1;">
                <input type="number" placeholder="Pre√ßo" value="0.00" step="0.01" style="flex: 1;">
                <button type="button" onclick="this.parentElement.remove()" style="background: #dc3545;">-</button>
            `;
            itemsDiv.appendChild(newItem);
        }

        // Testar fun√ß√£o diretamente
        function testarFuncao() {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `
                <div class="result info">
                    <h3>üîß Teste da Fun√ß√£o de E-mail</h3>
                    <p>Testando a fun√ß√£o de envio de e-mail diretamente...</p>
                </div>
            `;

            fetch('https://us-central1-compreaqui-324df.cloudfunctions.net/enviarEmail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nome: 'Teste de Notifica√ß√£o',
                    email: 'teste@exemplo.com',
                    mensagem: 'Este √© um teste da fun√ß√£o de notifica√ß√£o por e-mail para novos pedidos.'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultado.innerHTML = `
                        <div class="result success">
                            <h3>‚úÖ Fun√ß√£o de E-mail Funcionando!</h3>
                            <p><strong>Mensagem:</strong> ${data.message}</p>
                            <p><strong>ID:</strong> ${data.data?.id || 'N/A'}</p>
                        </div>
                    `;
                } else {
                    resultado.innerHTML = `
                        <div class="result error">
                            <h3>‚ùå Erro na Fun√ß√£o de E-mail</h3>
                            <p><strong>Erro:</strong> ${data.error}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultado.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Erro de Conex√£o</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            });
        }

        // Formul√°rio principal
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btnTestar = document.getElementById('btnTestar');
            const resultado = document.getElementById('resultado');
            
            btnTestar.disabled = true;
            btnTestar.textContent = 'Testando...';
            resultado.innerHTML = '';
            
            // Coletar dados do formul√°rio
            const formData = new FormData(e.target);
            const items = [];
            
            document.querySelectorAll('.item-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0].value && inputs[1].value && inputs[2].value) {
                    items.push({
                        nome: inputs[0].value,
                        quantidade: parseInt(inputs[1].value),
                        preco: parseFloat(inputs[2].value)
                    });
                }
            });
            
            const pedidoData = {
                total: parseFloat(formData.get('total')),
                status: formData.get('status'),
                paymentMethod: formData.get('paymentMethod'),
                endereco: {
                    nome: formData.get('nome'),
                    telefone: formData.get('telefone'),
                    rua: formData.get('rua'),
                    numero: formData.get('numero'),
                    bairro: formData.get('bairro'),
                    cidade: formData.get('cidade')
                },
                items: items,
                userId: 'test-user-' + Date.now(),
                createdAt: new Date(),
                createdAtTimestamp: Date.now()
            };
            
            if (formData.get('paymentMethod') === 'dinheiro' && formData.get('valorPago')) {
                pedidoData.valorPago = parseFloat(formData.get('valorPago'));
                pedidoData.troco = pedidoData.valorPago - pedidoData.total;
            }
            
            try {
                resultado.innerHTML = `
                    <div class="result info">
                        <h3>üîÑ Simulando Cria√ß√£o de Pedido...</h3>
                        <p><strong>ID do Pedido:</strong> test-${Date.now()}</p>
                        <p><strong>Valor Total:</strong> R$ ${pedidoData.total.toFixed(2)}</p>
                        <p><strong>Cliente:</strong> ${pedidoData.endereco.nome}</p>
                        <p><strong>Itens:</strong> ${pedidoData.items.length}</p>
                        <p><em>Nota: Este √© um teste simulado. A notifica√ß√£o real s√≥ funciona quando um pedido √© criado no Firestore.</em></p>
                    </div>
                `;
                
                // Simular delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                resultado.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Teste Conclu√≠do!</h3>
                        <p><strong>Status:</strong> Simula√ß√£o de pedido criada com sucesso!</p>
                        <p><strong>Nota:</strong> Para testar a notifica√ß√£o real, voc√™ precisa criar um pedido atrav√©s do sistema normal do e-commerce.</p>
                        <p><strong>Como testar:</strong></p>
                        <ul>
                            <li>1. Acesse o site normalmente</li>
                            <li>2. Adicione produtos ao carrinho</li>
                            <li>3. Finalize um pedido</li>
                            <li>4. Verifique seu e-mail (frank.melo.wal@gmail.com)</li>
                        </ul>
                    </div>
                `;
                
            } catch (error) {
                resultado.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Erro no Teste</h3>
                        <p><strong>Erro:</strong> ${error.message}</p>
                    </div>
                `;
            } finally {
                btnTestar.disabled = false;
                btnTestar.textContent = 'üß™ Testar Notifica√ß√£o';
            }
        });
    </script>
</body>
</html>
